import{f as e,u as t,r as n,j as r}from"./react-vendor-2SZXphvN.js";import{S as s}from"./SEO-CLq8vwqd.js";import"./vendor-invariant-BME_2b6A.js";import"./vendor-shallowequal-CcIhOdxx.js";import"./vendor-scheduler-BVKd3TJG.js";import"./vendor-@remix-run-BWfEV5os.js";const o="http://172.20.10.2:8080",i=o+"/api/payment",a=()=>{const[a]=e(),c=t(),[d,m]=n.useState(!0),[l,u]=n.useState(""),p=e=>{if(!0===e.success||!0===e.isSuccess){const t=e.data||e.orderNumber||e.order||null,n=JSON.parse(sessionStorage.getItem("checkoutData")||"{}"),r={orderNumber:t||"SİPARİŞ-"+Date.now(),contactInfo:n.contactInfo||{},addressInfo:n.addressInfo||{},cardInfo:n.cardInfo||{},items:n.items||[],totalPrice:n.totalPrice||0};sessionStorage.removeItem("checkoutData"),sessionStorage.removeItem("pendingPaymentId"),sessionStorage.removeItem("pendingConversationId"),sessionStorage.setItem("lastOrderData",JSON.stringify(r)),window.location.replace("/siparis-onayi")}else{const t=e.message||e.error||"Ödeme işlemi başarısız oldu.";sessionStorage.removeItem("pendingPaymentId"),sessionStorage.removeItem("pendingConversationId"),sessionStorage.setItem("paymentError",t),window.location.replace("/odeme-basarisiz")}},h=()=>{const e=document.querySelectorAll("pre");for(const s of e){const e=s.textContent||s.innerText;if(e.trim().startsWith("{")&&e.trim().endsWith("}"))try{return JSON.parse(e.trim())}catch(r){}}const t=(document.body.innerText||document.body.textContent||"").match(/\{[\s\S]*"success"[\s\S]*\}/);if(t)try{return JSON.parse(t[0])}catch(r){}const n=document.querySelectorAll('textarea, input[type="text"]');for(const s of n){const e=s.value||s.textContent||"";if(e.trim().startsWith("{")&&e.trim().endsWith("}"))try{return JSON.parse(e.trim())}catch(r){}}return null},y=async(e,t)=>{try{const s=`${i}/3d-callback?paymentId=${encodeURIComponent(e)}&conversationId=${encodeURIComponent(t)}`,o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"}}),a=o.headers.get("content-type")||"",c=await o.text(),d=o.status;if(c.includes("Whitelabel Error Page")||c.includes("This application has no explicit mapping")||c.trim().startsWith("<!DOCTYPE")||c.trim().startsWith("<html")&&!c.includes("iyzico")){const e="Sunucuda bir hata oluştu. Lütfen daha sonra tekrar deneyiniz.";return sessionStorage.setItem("paymentError",e),void window.location.replace("/odeme-basarisiz")}if(!o.ok||d>=400){let e="Ödeme işlemi sırasında bir hata oluştu.";if(c.trim().startsWith("{")&&c.trim().endsWith("}"))try{const t=JSON.parse(c);e=t.message||t.error||e}catch(n){}return sessionStorage.setItem("paymentError",e),void window.location.replace("/odeme-basarisiz")}let m;if(!(a.includes("application/json")||c.trim().startsWith("{")&&c.trim().endsWith("}")))return sessionStorage.setItem("paymentError","Beklenmeyen yanıt formatı: "+(a||"bilinmiyor")),void window.location.replace("/odeme-basarisiz");try{if(!c||""===c.trim())return sessionStorage.setItem("paymentError","Sunucudan yanıt alınamadı."),void window.location.replace("/odeme-basarisiz");m=JSON.parse(c)}catch(r){return sessionStorage.setItem("paymentError","Sunucu yanıtı işlenemedi: "+r.message),void window.location.replace("/odeme-basarisiz")}p(m)}catch(s){const e=s.message||"Ödeme işlemi sırasında bir hata oluştu. Lütfen daha sonra tekrar deneyiniz.";sessionStorage.setItem("paymentError",e),window.location.replace("/odeme-basarisiz")}};return n.useEffect(()=>{(async()=>{const e=new URLSearchParams(window.location.search),t=e.get("order")||a.get("order");if(t){const e=JSON.parse(sessionStorage.getItem("checkoutData")||"{}"),n={orderNumber:t,contactInfo:e.contactInfo||{},addressInfo:e.addressInfo||{},cardInfo:e.cardInfo||{},items:e.items||[],totalPrice:e.totalPrice||0};return sessionStorage.removeItem("checkoutData"),sessionStorage.setItem("lastOrderData",JSON.stringify(n)),void window.location.replace("/siparis-onayi")}let n=e.get("paymentId")||a.get("paymentId"),r=e.get("conversationId")||a.get("conversationId");if(n&&r)return sessionStorage.setItem("pendingPaymentId",n),sessionStorage.setItem("pendingConversationId",r),void(await y(n,r));const s=()=>{if(document.body){const t=document.body.innerHTML?.trim()||"",n=document.body.textContent?.trim()||document.body.innerText?.trim()||"";if(t&&t.startsWith("{")&&t.endsWith("}")&&!t.includes("<html")&&!t.includes("<body")&&!t.includes("<!DOCTYPE"))try{const e=JSON.parse(t);if(void 0!==e.success||void 0!==e.isSuccess||e.message)return p(e),!0}catch(e){}if(n&&n.startsWith("{")&&n.endsWith("}")&&!n.includes("<")&&!n.includes("html")&&!n.includes("HTML"))try{const e=JSON.parse(n);if(void 0!==e.success||void 0!==e.isSuccess||e.message)return p(e),!0}catch(e){}}return!1};if(s())return;"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",()=>{s()}),"complete"!==document.readyState&&window.addEventListener("load",()=>{s()});const i=window.location.href;if(window.location.pathname,i.includes("172.20.10.2:8080")||i.includes(o)){if(s())return;const e=new URL(i),t=e.searchParams.get("paymentId"),n=e.searchParams.get("conversationId");if(t&&n)return void(await y(t,n))}const c=h();if(c)return void p(c);if(n&&r)return void(await y(n,r));const d=sessionStorage.getItem("pendingPaymentId"),m=sessionStorage.getItem("pendingConversationId");if(d&&m)return sessionStorage.removeItem("pendingPaymentId"),sessionStorage.removeItem("pendingConversationId"),void(await y(d,m));if(sessionStorage.getItem("paymentError"))return void window.location.replace("/odeme-basarisiz");let l=0;const u=setInterval(()=>{l++;const e=h();if(e)return clearInterval(u),void p(e);if(document.body&&document.body.textContent){const e=document.body.textContent.trim();if(e.startsWith("{")&&e.endsWith("}")||e.startsWith("[")&&e.endsWith("]"))try{const t=JSON.parse(e);if(void 0!==t.success||void 0!==t.isSuccess||t.message)return clearInterval(u),void p(t)}catch(t){}}if(window.location.href.includes(o)){const e=document.body?.textContent?.trim()||document.body?.innerText?.trim()||"";if(e.startsWith("{")&&e.endsWith("}"))try{const t=JSON.parse(e);if(void 0!==t.success||void 0!==t.isSuccess||t.message)return clearInterval(u),void p(t)}catch(t){}if(1===l){const e=new URLSearchParams(window.location.search),t=e.get("paymentId"),n=e.get("conversationId");if(t&&n)return clearInterval(u),void y(t,n)}}10>l||(clearInterval(u),sessionStorage.setItem("paymentError","Ödeme bilgileri bulunamadı. Lütfen tekrar deneyiniz."),window.location.replace("/odeme-basarisiz"))},300)})()},[a,c]),r.jsxs("div",{className:"payment-3d-callback-container",children:[r.jsx(s,{title:"Ödeme İşleniyor",description:"3D Secure ödeme işleminiz tamamlanıyor. Lütfen bekleyiniz.",keywords:"3d ödeme, ödeme doğrulama, güvenli ödeme",url:"/payment/3d-callback",structuredData:{"@context":"https://schema.org","@type":"WebPage",name:"3D Ödeme Doğrulama",description:"3D Secure ödeme işleminiz tamamlanıyor."}}),r.jsx("div",{className:"callback-content",children:d?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"loading-spinner",children:r.jsx("div",{className:"spinner"})}),r.jsx("h2",{children:"Ödeme İşleniyor"}),r.jsx("p",{children:"3D Secure ödeme işleminiz tamamlanıyor. Lütfen bekleyiniz..."}),r.jsx("p",{className:"redirect-note",children:"Yönlendiriliyorsunuz..."})]}):l?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"error-icon",children:r.jsxs("svg",{width:"60",height:"60",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"10"}),r.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),r.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]})}),r.jsx("h2",{children:"İşlem Başarısız"}),r.jsx("p",{className:"error-text",children:l}),r.jsx("button",{onClick:()=>window.location.replace("/checkout"),className:"btn-retry",children:"Ödemeyi Tekrar Dene"})]}):null})]})};export{a as default};
